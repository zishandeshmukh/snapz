<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SnapMind Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg: #09090b; --text: #fff; --muted: #a1a1aa; --accent: #fff; --border: #27272a; }
    body { background: var(--bg); color: var(--text); font-family: system-ui; margin: 0; min-height: 100vh; }
    #app { display: none; }
    #auth { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .auth-box { width: 100%; max-width: 400px; padding: 32px; }
    h1 { font-size: 32px; margin-bottom: 8px; }
    .subtitle { color: var(--muted); font-size: 16px; margin-bottom: 40px; }
    input { width: 100%; padding: 16px; margin: 8px 0; background: #1a1a1a; border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 16px; }
    button { width: 100%; padding: 16px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-weight: bold; margin-top: 16px; cursor: pointer; font-size: 16px; }
    .link { color: var(--muted); text-align: center; margin-top: 16px; cursor: pointer; font-size: 14px; }
    .error { color: #ef4444; font-size: 13px; margin-top: 8px; }
    
    /* Dashboard Styles */
    .dashboard { padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .quick-add { display: flex; gap: 8px; margin-bottom: 24px; }
    .quick-add input { flex: 1; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .card { background: #1a1a1a; padding: 16px; border-radius: 12px; border: 1px solid var(--border); }
    .card h3 { margin: 0 0 8px 0; font-size: 18px; }
    .card p { margin: 0 0 8px 0; color: var(--muted); }
    .card small { font-size: 12px; color: #71717a; }
    .loading { text-align: center; padding: 40px; }
    .logout { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth">
    <div class="auth-box">
      <h1 id="authTitle">Welcome Back</h1>
      <div class="subtitle">Capture & recall your digital life</div>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="authBtn">Login</button>
      <div class="link" id="toggleLink">Don't have an account? Sign up</div>
      <div class="error" id="error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="app">
    <div class="dashboard">
      <div class="header">
        <h1>SnapMind Dashboard</h1>
        <button class="logout" onclick="logout()">Logout</button>
      </div>
      
      <div class="quick-add">
        <input type="text" id="quickAdd" placeholder="Quick add a note...">
        <button onclick="quickAdd()">Add</button>
      </div>

      <div id="snapsGrid" class="grid"></div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://your-project.supabase.co',
      'YOUR_ANON_KEY'
    );

    let isLoginMode = true;

    // Toggle auth mode
    document.getElementById('toggleLink').addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Welcome Back' : 'Create Account';
      document.getElementById('authBtn').textContent = isLoginMode ? 'Login' : 'Sign Up';
      document.getElementById('toggleLink').textContent = isLoginMode 
        ? "Don't have an account? Sign up" 
        : 'Already have an account? Login';
    });

    // Auth submission
    document.getElementById('authBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('error');
      
      errorDiv.textContent = '';
      
      if (!email || !password) {
        errorDiv.textContent = 'Please fill all fields';
        return;
      }

      const { data, error } = isLoginMode
        ? await supabase.auth.signInWithPassword({ email, password })
        : await supabase.auth.signUp({ email, password });

      if (error) {
        errorDiv.textContent = error.message;
      }
      // On success, onAuthStateChange will fire
    });

    // Auth state change
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadSnaps();
      } else {
        document.getElementById('auth').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
      }
    });

    // Load snaps
    async function loadSnaps() {
      const grid = document.getElementById('snapsGrid');
      grid.innerHTML = '<div class="loading">Loading...</div>';

      const { data: { user } } = await supabase.auth.getUser();
      const { data: snaps, error } = await supabase
        .from('content_documents')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        grid.innerHTML = `<div class="error">${error.message}</div>`;
        return;
      }

      if (!snaps || snaps.length === 0) {
        grid.innerHTML = '<div class="loading">No snaps yet. Add your first note!</div>';
        return;
      }

      grid.innerHTML = snaps.map(snap => `
        <div class="card">
          <h3>${snap.title || 'Untitled'}</h3>
          <p>${snap.summary || snap.raw_text?.substring(0, 100)}...</p>
          <small>${snap.category || 'note'} â€¢ ${new Date(snap.created_at).toLocaleDateString()}</small>
        </div>
      `).join('');
    }

    // Quick add
    async function quickAdd() {
      const input = document.getElementById('quickAdd');
      const text = input.value.trim();
      if (!text) return;

      const { data: { user } } = await supabase.auth.getUser();
      
      // Send to backend for AI processing
      const response = await fetch('https://your-backend.onrender.com/receive_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text,
          user_id: user.id,
          source: 'W'
        })
      });

      if (response.ok) {
        input.value = '';
        loadSnaps(); // Refresh
      }
    }

    // Logout
    async function logout() {
      await supabase.auth.signOut();
    }
  </script>
</body>
</html>